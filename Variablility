import pandas as pd


import pandas as pd

def calculate_remaining_age_cost(df):
    # Sort by bike, dispatch month, and age ascending for efficient slicing
    df = df.sort_values(['BIKE_GROUPED', 'DISPATCH_MONTH', 'AGE'])
    
    # Create a dictionary to hold cumulative sums by bike and dispatch month for quick lookup
    cumulative_costs = {}

    # Group by bike and dispatch month
    grouped = df.groupby(['BIKE_GROUPED', 'DISPATCH_MONTH'])

    # For each group, calculate cumulative sums of warranty cost from highest age down to lowest
    for (bike, dispatch_month), group in grouped:
        group_sorted = group.sort_values('AGE', ascending=False)
        cum_sum = group_sorted['WARRANTY_COST'].cumsum().iloc[::-1].reset_index(drop=True)
        
        # Map cumulative sum back to age
        age_to_cum_cost = dict(zip(group_sorted['AGE'][::-1].values, cum_sum))
        
        cumulative_costs[(bike, dispatch_month)] = age_to_cum_cost

    # Function to get cumulative cost for each row
    def get_cum_cost(row):
        bike = row['BIKE_GROUPED']
        dispatch_month = row['DISPATCH_MONTH']
        age = row['AGE']
        return cumulative_costs.get((bike, dispatch_month), {}).get(age, 0)

    # Apply function to dataframe
    df['REMAINING_AGE_COST'] = df.apply(get_cum_cost, axis=1)

    return df



def create_model_sheets_with_remaining_costs(
    df, start_dispatch_month, end_dispatch_month, output_filename='model_warranty_costs_remaining.xlsx'
):
    df['DISPATCH_MONTH'] = pd.to_datetime(df['DISPATCH_MONTH'], format='%Y-%m')
    start_date = pd.to_datetime(start_dispatch_month, format='%Y-%m')
    end_date = pd.to_datetime(end_dispatch_month, format='%Y-%m')

    # Filter dispatch months within the provided range
    df_filtered = df[(df['DISPATCH_MONTH'] >= start_date) & (df['DISPATCH_MONTH'] <= end_date)].copy()

    # Calculate remaining age cost using the method discussed
    df_filtered = calculate_remaining_age_cost(df_filtered)

    # Calculate remaining age and per unit, per month costs
    df_filtered['REMAINING_AGE'] = 60 - df_filtered['AGE']
    df_filtered['PER_UNIT_COST'] = df_filtered['REMAINING_AGE_COST'] / df_filtered['VOLUME'] / df_filtered['REMAINING_AGE']
    df_filtered['PER_MONTH_COST'] = df_filtered['PER_UNIT_COST'] * df_filtered['VOLUME']

    with pd.ExcelWriter(output_filename, engine='xlsxwriter') as writer:
        bike_models = df_filtered['BIKE_GROUPED'].unique()

        for model in bike_models:
            model_df = df_filtered[df_filtered['BIKE_GROUPED'] == model].copy()
            data_for_export = pd.DataFrame()

            for idx, row in model_df.iterrows():
                start_month = row['DISPATCH_MONTH']
                remaining_months = row['REMAINING_AGE']
                per_unit_cost = row['PER_UNIT_COST']

                index_label = f'{model}_{row.AGE}_{start_month.strftime("%Y-%m")}'
                if index_label not in data_for_export.index:
                    data_for_export.loc[index_label] = 0

                for month_offset in range(remaining_months):
                    month_label = (start_month + pd.DateOffset(months=month_offset)).strftime('%Y-%m')
                    if month_label not in data_for_export.columns:
                        data_for_export[month_label] = 0
                    data_for_export.at[index_label, month_label] += per_unit_cost

            data_for_export.fillna(0, inplace=True)
            data_for_export.to_excel(writer, sheet_name=model)

    print(f'Data saved in {output_filename}')


# Make sure to have the calculate_remaining_age_cost function defined from above

# Example usage:
# create_model_sheets_with_remaining_costs(df, '2020-01', '2023-01')
